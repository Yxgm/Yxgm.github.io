<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********    -----Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<!--<![endif]-->

<head>
  <title>时间绑定原理 | 一宿更名_BLOG</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="一宿更名_BLOG">
    <meta name="author" content="盛祥玉">
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="一宿更名_BLOG" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
    
    <link rel="stylesheet" href="/highlightjs/vs.css" type="text/css">
    

    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->

  
  
  

  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close"/>
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            <li>
                <a class="sb-toggle-submenu">Works<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                        <li><a href="/" target="_BLANK" class="animsition-link">AAA</a></li>
                    
                        <li><a href="/atom.xml" target="_BLANK" class="animsition-link">BBB</a></li>
                    
                </ul>
            </li>
            
            
        	<li>
        		<a class="sb-toggle-submenu">Categories<span class="sb-caret"></span></a>
            	<ul class="sb-submenu">
				  	
				    <li><a href="/categories/1-Css/" class="animsition-link">1-Css<small>(11)</small></a></li>
				    
				    <li><a href="/categories/1-JavaScript/" class="animsition-link">1-JavaScript<small>(14)</small></a></li>
				    
				    <li><a href="/categories/1-TypeScript/" class="animsition-link">1-TypeScript<small>(3)</small></a></li>
				    
				    <li><a href="/categories/2-React/" class="animsition-link">2-React<small>(10)</small></a></li>
				    
				    <li><a href="/categories/2-React-Hooks/" class="animsition-link">2-React_Hooks<small>(5)</small></a></li>
				    
				    <li><a href="/categories/2-Redux和Router/" class="animsition-link">2-Redux和Router<small>(9)</small></a></li>
				    
				    <li><a href="/categories/2-Vue/" class="animsition-link">2-Vue<small>(12)</small></a></li>
				    
				    <li><a href="/categories/3-Brower/" class="animsition-link">3-Brower<small>(30)</small></a></li>
				    
				    <li><a href="/categories/4-Node/" class="animsition-link">4-Node<small>(1)</small></a></li>
				    
				    <li><a href="/categories/4-Promise/" class="animsition-link">4-Promise<small>(7)</small></a></li>
				    
				    <li><a href="/categories/4-Webpack/" class="animsition-link">4-Webpack<small>(8)</small></a></li>
				    
				    <li><a href="/categories/业务和思想/" class="animsition-link">业务和思想<small>(15)</small></a></li>
				    
				    <li><a href="/categories/前端大项/" class="animsition-link">前端大项<small>(9)</small></a></li>
				    
				    <li><a href="/categories/基础补充/" class="animsition-link">基础补充<small>(5)</small></a></li>
				    
				    <li><a href="/categories/框架差异/" class="animsition-link">框架差异<small>(8)</small></a></li>
				    
				    <li><a href="/categories/算法相关/" class="animsition-link">算法相关<small>(10)</small></a></li>
				    
				    <li><a href="/categories/超脱领悟/" class="animsition-link">超脱领悟<small>(9)</small></a></li>
				    
				    <li><a href="/categories/面试复盘/" class="animsition-link">面试复盘<small>(1)</small></a></li>
				    
				</ul>
        	</li>
			
            
            <li>
                <a class="sb-toggle-submenu">Links<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                    <li><a target="_blank" rel="noopener" href="http://go.kieran.top/" class="animsition-link">Kieran</a></li>
                    
                    <li><a target="_blank" rel="noopener" href="http://domain.com/" class="animsition-link">Name</a></li>
                    
                </ul>
            </li>
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            
            <li><a href="/about.html" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>
    
    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/logo.png" alt="Logo" width="35px;"/> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">一宿更名_BLOG</a></li>
                            <li class="nolink"><span>Always </span>Creative.</li>
                            
                            <li><a href="https://github.com/Yxgm" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            
                            
                            
                            <li class="nolink"><span>Welcome!</span></li>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->


      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2022-06-07T11:19:13.987Z" itemprop="datePublished">
          2022-06-07
      </time>
    
    
    | 
    <a href='/tags/vue/'>vue</a>,
    
    <a href='/tags/事件绑定/'>事件绑定</a>
    
    
</span>
                <h1>时间绑定原理</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<p>template字符串转化成ast，加工（优化），变成render函数字符串</p>
<h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><h4 id="原生dom事件"><a href="#原生dom事件" class="headerlink" title="原生dom事件"></a>原生dom事件</h4><p>Vue 在挂载实例前，有相当多的工作是进行模板的编译，将 template 模板进行编译，解析成 AST 树，再转换成 render 函数，而在编译阶段，就是对事件的指令做收集处理。在 template 模板中，定义事件的部分是属于 XML 的 Attribute，所以收集指令时需要匹配 Attributes 以确定哪个 Attribute 是属于事件。编译模板提取事件收集指令以及生成 render 字符串和 render 函数，但是事件真正的绑定到 DOM 上还是离不开事件注册，此阶段就发生在 patchVnode 过程中，在生成完成 VNode 后，进行 patchVnode 过程中创建真实 DOM 时会进行事件注册的相关钩子处理。invokeCreateHooks 就是一个模板指令处理的任务，他分别针对不同的指令为真实阶段创建不同的任务，针对事件，这里会调 updateDOMListeners 对真实的 DOM 节点注册事件任务。最终添加与移除事件都是调用的 add 与 remove 方法，最终调用的方法即 DOM 的 ddEventListener 方法与 removeEventListener 方法。</p>
<ul>
<li>vue 通过解析 template 里的 html 提取出 DOM 上的所有属性</li>
<li>过正则匹配出对应的事件名和对应的事件执行方法</li>
<li>通过 gen 方法生成事件虚拟渲染函数，事件作为属性注入到虚拟 DOM 里</li>
<li>在 el 的 events 里维护了事件和事件对应的内容方法以及修饰符，以及是否是动态事件名等信息</li>
<li>虚拟 DOM 转化到实际 DOM，并调用原生 addEventListener 绑定事件</li>
</ul>
<h4 id="自定义事件"><a href="#自定义事件" class="headerlink" title="自定义事件"></a>自定义事件</h4><p>发布订阅，EventBus</p>
<p>原生 DOM 事件和自定义组件的事件在生成 虚拟 DOM 之前没有什么分别，但再生成虚拟 DOM 后，前者依旧再 <code>VNode.data.on</code> 上，而后者则直接到 <code>VNode.componentOptions.listeners</code>。前者会通过 <code>addEventListener</code> 添加到 DOM 上，后者会在组件初始化的时候通过中通过 <code>$on</code> 以键值对的形式存放到 <code>_events</code> 中，并可以通过 <code>$emit</code> 触发指定的监听事件。</p>
<p>原生 DOM 事件和自定义组件的事件在生成 虚拟 DOM 之前没有什么分别，但再生成虚拟 DOM 后，前者依旧再 <code>VNode.data.on</code> 上，而后者则直接到 <code>VNode.componentOptions.listeners</code>。前者会通过 <code>addEventListener</code> 添加到 DOM 上，后者会在组件初始化的时候通过中通过 <code>$on</code> 以键值对的形式存放到 <code>_events</code> 中，并可以通过 <code>$emit</code> 触发指定的监听事件。</p>
<h3 id="vue-如何优化事件"><a href="#vue-如何优化事件" class="headerlink" title="vue 如何优化事件"></a>vue 如何优化事件</h3><p>vue 在处理大列表绑定事件的时候，是有一定的性能问题的，框架内部没有把事件提到父节点上来做事件委托，唯一优化的是列表之间绑定的事件指向的函数都是同一个引用，且在 DOM 销毁的时候能主动销毁事件，所以能负载一定的数据量，如果业务里的确存在非常大量的数据，建议还是自己在父节点上进行事件绑定，或者改变交互，进行分页。</p>
<h2 id="自我理解"><a href="#自我理解" class="headerlink" title="自我理解"></a>自我理解</h2><p>Vue在挂载实例前，有相当多的工作是在进行模版编译，将template模版进行编译，解析成ast树，再转化成render函数，而我们常使用的v-on或者@在模版上绑定事件，是template编译进行的。</p>
<p>编译入口：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ast = <span class="title function_">parse</span>(template.<span class="title function_">trim</span>(),options);   attribute<span class="comment">//e 吹 build t</span></span><br></pre></td></tr></table></figure>

<p>parse通过拆分模版字符串，将其解析成一个ast树，函数processAttr函数对ast单个节点进行属性的处理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">processAttrs</span>(el)<span class="comment">//el是ast树 外层递归遍历，内层processAttrs处理属性</span></span><br></pre></td></tr></table></figure>

<p>函数内部匹配事件相关的正则，命中匹配的记过会得到事件指令相关内容，包括事件本身，事件回调以及事件修饰符。最终通过<code>addHandler</code>方法，为<code>AST</code>树添加事件相关的属性。而<code>addHandler</code>还有一个重要功能是对事件修饰符进行特殊处理。</p>
<img src='../assets/as.jpg' width="40%" style="margin:0 auto">

<p>现在的ast树上已经有了events属性，有事件的名字，和函数名和一些修饰符等等。</p>
<p>接下来就需要生成代码了，将ast和options扔入generate生成器函数中，var code &#x3D; generate(ast,options)，拼串的一个过程。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">generate</span> (ast,options) &#123;</span><br><span class="line">    <span class="keyword">var</span> state = <span class="keyword">new</span> <span class="title class_">CodegenState</span>(options);</span><br><span class="line">    <span class="keyword">var</span> code = ast ? <span class="title function_">genElement</span>(ast, state) : <span class="string">&#x27;_c(&quot;div&quot;)&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">render</span>: (<span class="string">&quot;with(this)&#123;return &quot;</span> + code + <span class="string">&quot;&#125;&quot;</span>), <span class="comment">// with函数</span></span><br><span class="line">      <span class="attr">staticRenderFns</span>: state.<span class="property">staticRenderFns</span></span><br><span class="line">    &#125;<span class="comment">//返回render函数字符串</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>经过这一转换后，生成<code>with</code>封装的<code>render</code>函数如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;_c(&#x27;div&#x27;,&#123;attrs:&#123;&quot;</span>id<span class="string">&quot;:&quot;</span>app<span class="string">&quot;&#125;&#125;,[_c(&#x27;div&#x27;,&#123;on:&#123;&quot;</span>click<span class="string">&quot;:function($event)&#123;$event.stopPropagation();return doThis($event)&#125;&#125;&#125;,[_v(&quot;</span>点击<span class="string">&quot;)]),_v(&quot;</span> <span class="string">&quot;),_c(&#x27;span&#x27;,[_v(_s(count))])])&quot;</span></span><br></pre></td></tr></table></figure>

<p>以上描述的是模板上的事件标记在构建<code>AST</code>树上是怎么处理，并且如何根据构建的<code>AST</code>树返回正确的<code>render</code>渲染函数，<strong>但是真正事件绑定还是离不开绑定注册事件</strong>。这一个阶段就是发生在组件挂载的阶段。 有了<code>render</code>函数，自然可以生成实例挂载需要的<code>Vnode</code>树，并且会进行<code>patchVnode</code>的环节进行真实节点的构建</p>
<p>render函数执行，生成vnode，遍历子节点递归调用createElement为每一个子节点创建真实的dom，由于vnode中有data属性，在创建真实dom的时候，回进行钩子回调。</p>
<p>在创建dom的时候，<code>add</code>和<code>remove</code>是真正在<code>DOM</code>上绑定事件和解绑事件的过程，它的实现也是利用了原生<code>DOM</code>的<code>addEventListener,removeEventListener api</code>。</p>
<p><strong>最后，我们换一个角度理解父子组件通信，组件自定义事件的触发和监听本质上都是在当前的组件实例中进行，之所以能产生父子组件通信的效果是因为事件监听的回调函数写在了父组件中。</strong></p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903919290679304#heading-2">https://juejin.cn/post/6844903919290679304#heading-2</a></p>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="m-pagination col-md-8 col-md-offset-2 col-sm-24" role="pagination">
    
    <a class="pull-left" href="/2-React_Hooks/useEffect/" style="float: left;">
        ← useEffect
    </a>
    
    
    <a class="pull-right" href="/3-Brower/%E5%8A%A0%E8%BD%BD%E9%A1%BA%E5%BA%8F/">
        加载顺序 →
    </a>
    
</nav>

        <div class="col-md-8 col-md-offset-2 col-sm-24"><script type="text/javascript">
  /**
   * 搜狐畅言
   */

  /*
  document.write('<div id="SOHUCS" sid="' + window.location.pathname.slice(1) + '" ></div>');

  window.onload = function () {
    (function () {
      var appid = 'cytXXXX';
      var conf = 'prod_xxxxxxxxxxxxxxxxx';
      var width = window.innerWidth || document.documentElement.clientWidth;
      var loadJs = function (d, a, id) {
        var c = document.getElementsByTagName("head")[0] || document.head || document.documentElement;
        var b = document.createElement("script");
        b.setAttribute("type", "text/javascript");
        b.setAttribute("charset", "UTF-8");
        b.setAttribute("src", d);
        if (id) {
          b.setAttribute("id", id);
        }
        if (typeof a === "function") {
          if (window.attachEvent) {
            b.onreadystatechange = function () {
              var e = b.readyState;
              if (e === "loaded" || e === "complete") {
                b.onreadystatechange = null;
                a()
              }
            }
          } else {
            b.onload = a
          }
        }
        c.appendChild(b)
      };

      loadJs("https://changyan.sohu.com/upload/changyan.js", function () {
        window.changyan.api.config({
          appid: appid,
          conf: conf
        })
      });
    })();
  }
  */

</script>
</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By 盛祥玉. All Rights Reserved.
                </p>
                <p>Theme By <a target="_blank" rel="noopener" href="//go.kieran.top" style="color: #767D84">Kieran</a></p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/Yxgm" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    
                    
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->
      <!-- Load our scripts -->
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };

    resizeHero();

    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$('#intro').find('img').each(function(){
  var alt = this.alt;

  if (alt){
    $(this).after('<span class="caption" style="display:none">' + alt + '</span>');
  }

  $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="gallery" />');
});
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



      
</body>
</html>
