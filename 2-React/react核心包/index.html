<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********    -----Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<!--<![endif]-->

<head>
  <title>React核心包 | 一宿更名_BLOG</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="一宿更名_BLOG">
    <meta name="author" content="盛祥玉">
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="一宿更名_BLOG" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
    
    <link rel="stylesheet" href="/highlightjs/vs.css" type="text/css">
    

    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->

  
  
  

  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close"/>
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            <li>
                <a class="sb-toggle-submenu">Works<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                        <li><a href="/" target="_BLANK" class="animsition-link">AAA</a></li>
                    
                        <li><a href="/atom.xml" target="_BLANK" class="animsition-link">BBB</a></li>
                    
                </ul>
            </li>
            
            
        	<li>
        		<a class="sb-toggle-submenu">Categories<span class="sb-caret"></span></a>
            	<ul class="sb-submenu">
				  	
				    <li><a href="/categories/1-Css/" class="animsition-link">1-Css<small>(11)</small></a></li>
				    
				    <li><a href="/categories/1-JavaScript/" class="animsition-link">1-JavaScript<small>(14)</small></a></li>
				    
				    <li><a href="/categories/1-TypeScript/" class="animsition-link">1-TypeScript<small>(3)</small></a></li>
				    
				    <li><a href="/categories/2-React/" class="animsition-link">2-React<small>(10)</small></a></li>
				    
				    <li><a href="/categories/2-React-Hooks/" class="animsition-link">2-React_Hooks<small>(5)</small></a></li>
				    
				    <li><a href="/categories/2-Redux和Router/" class="animsition-link">2-Redux和Router<small>(9)</small></a></li>
				    
				    <li><a href="/categories/2-Vue/" class="animsition-link">2-Vue<small>(12)</small></a></li>
				    
				    <li><a href="/categories/3-Brower/" class="animsition-link">3-Brower<small>(30)</small></a></li>
				    
				    <li><a href="/categories/4-Node/" class="animsition-link">4-Node<small>(1)</small></a></li>
				    
				    <li><a href="/categories/4-Promise/" class="animsition-link">4-Promise<small>(7)</small></a></li>
				    
				    <li><a href="/categories/4-Webpack/" class="animsition-link">4-Webpack<small>(8)</small></a></li>
				    
				    <li><a href="/categories/业务和思想/" class="animsition-link">业务和思想<small>(15)</small></a></li>
				    
				    <li><a href="/categories/前端大项/" class="animsition-link">前端大项<small>(9)</small></a></li>
				    
				    <li><a href="/categories/基础补充/" class="animsition-link">基础补充<small>(5)</small></a></li>
				    
				    <li><a href="/categories/框架差异/" class="animsition-link">框架差异<small>(8)</small></a></li>
				    
				    <li><a href="/categories/算法相关/" class="animsition-link">算法相关<small>(10)</small></a></li>
				    
				    <li><a href="/categories/超脱领悟/" class="animsition-link">超脱领悟<small>(9)</small></a></li>
				    
				    <li><a href="/categories/面试复盘/" class="animsition-link">面试复盘<small>(1)</small></a></li>
				    
				</ul>
        	</li>
			
            
            <li>
                <a class="sb-toggle-submenu">Links<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                    <li><a target="_blank" rel="noopener" href="http://go.kieran.top/" class="animsition-link">Kieran</a></li>
                    
                    <li><a target="_blank" rel="noopener" href="http://domain.com/" class="animsition-link">Name</a></li>
                    
                </ul>
            </li>
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            
            <li><a href="/about.html" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>
    
    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/logo.png" alt="Logo" width="35px;"/> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">一宿更名_BLOG</a></li>
                            <li class="nolink"><span>Always </span>Creative.</li>
                            
                            <li><a href="https://github.com/Yxgm" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            
                            
                            
                            <li class="nolink"><span>Welcome!</span></li>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->


      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2022-03-20T03:51:33.000Z" itemprop="datePublished">
          2022-03-20
      </time>
    
    
    | 
    <a href='/tags/react/'>react</a>
    
    
</span>
                <h1>React核心包</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<h1 id="react的三个核心包"><a href="#react的三个核心包" class="headerlink" title="react的三个核心包"></a>react的三个核心包</h1><p>前提:babel的作用，在没有进入<code>react</code>这三个包之前，所有的标签都已经转化成了<code>React.createElement</code>的形式，在react的处理之前，就已经成为了<code>vdom</code>元素（正常的业界<code>vdom</code>），</p>
<h3 id="1-React"><a href="#1-React" class="headerlink" title="1.  React"></a>1.  React</h3><p>提供处理虚拟dom的一些函数，和用户侧的一些hooks，经过React包的处理，所有的虚拟dom，都变成了react虚拟dom，标记上了type类型，onwer原生节点等等</p>
<h3 id="2-React-Reconciler"><a href="#2-React-Reconciler" class="headerlink" title="2. React Reconciler"></a>2. React Reconciler</h3><p><code>BeginWork（diff)、CompleteWork</code>，构建出fiber树</p>
<p><code>beginWork</code>阶段：根据<code>current fiber</code>和新<code>render</code>出来的<code>recat-Vdom</code>生成新的fiber节点，深度探索fiber树。但是此时的新构建出来的fiber树上的原生dom，并没有发生刷新。最后在<code>effectTag</code>上标记上了变动的标签</p>
<p><code>completeWork</code>阶段：自下而上的收集这些带有标签的fiber节点，依次链接起来，并且挂在rootFiber上。(说的是更新阶段)，</p>
<p><code>commitWork</code>阶段： 又分三个阶段</p>
<blockquote>
<p>Reconciliation细节</p>
<ol>
<li>如果当前节点不需要更新，则把子节点clone过来，跳到步骤5</li>
<li>跟新当前节点的props,state,context等，调用getDerivedStateFromProps静态方法</li>
<li>调用shouldComponentUpdate()，false的话，跳到步骤5</li>
<li>调用组件的render方法获得新的children, 进行reconcileChildren，为子节点创建fiber（创建过程会尽量复用现有fiber，子节点增删移动发生在这里，不是真实的dom节点，并标记effectTag，收集effect）</li>
<li>如果没有workInProgress.child，则工作单元结束，调用completeWork，如果是dom节点就diffProperties,标记tag，把effect list归并到return fiber，并把当前节点的sibling作为下一个工作单元；否则把child作为下一个工作单元</li>
<li>如果没有剩余可用时间了，等到下一次主线程空闲时才开始下一个工作单元；否则，立即开始做</li>
<li>当返回到root节点的时候，工作循环结束，进入commit阶段</li>
<li>commit阶段，标记isWorking &#x3D; true;此阶段不可打断</li>
<li>有三个大循环遍历effect list。主要是调用生命周期，将更新flush到屏幕上</li>
</ol>
</blockquote>
<h3 id="3-ReactDom"><a href="#3-ReactDom" class="headerlink" title="3. ReactDom"></a>3. ReactDom</h3><p>接收到effectList链，执行真正的dom操作，更改current Fiber上的真实dom节点。（commit操作）</p>
<p>两颗fiber树，共用一颗真实的dom树</p>
<p>当任务打断了之后，即交出执行权，让浏览器去渲染，之后在postMessage中又通知这个任务再次执行</p>
<p>已进入循环的时候，就会判断当前一帧的剩余时间还有没有空余，空余情况才</p>
<p>diff：（发生在beginWork阶段，生成链表的时候）</p>
<p>vdom和current比较生成workInProgress Fiber，同时生成了effect链表，</p>
<h3 id="模拟的requestIdleCallback函数"><a href="#模拟的requestIdleCallback函数" class="headerlink" title="模拟的requestIdleCallback函数"></a>模拟的requestIdleCallback函数</h3><p>用MessageChange，将一帧开始的时间传出（requestAnimationFraml的回调函数中有一帧开始的时间），随后在下一次事件循环中的宏任务首部（messagechange的回调在宏任务一开始就会执行），</p>
<blockquote>
<p> 补充：onmessage的回调函数的调用时机是在一帧的paint完成之后，所以说在onmessage中又调用那个循环的方法 </p>
</blockquote>
<p> 为什么不用生成器？</p>
<p>生成器有状态，重新执行的话，又会从头执行</p>
<h3 id="对于新旧多节点diff"><a href="#对于新旧多节点diff" class="headerlink" title="对于新旧多节点diff"></a>对于新旧多节点diff</h3><p>首先从头遍历新children，该节点新children有，而旧children没有的，直接插入旧children首部，都一次操作后都会记录新children的最后的修改位置（lastIndex）</p>
<p>因为只有insertBefore API，如果新c遍历可以复用的节点的话（key，type相同等等，直接复用dom节点），会移动改节点，就移动到lastIndex位置。</p>
<p>当新的children节点都已经全部插入到了旧children之后，会标识为最后一个节点，之后的节点不再需要，直接删掉</p>
<p>用户输入的时候，渲染相应的列表，18版本之前，使用防抖或者截流等，来控制视图渲染</p>
<p>18版本之后，startTrantale ：cd方法不在主线程上，相当于在一个分支上</p>
<p>节点移动最为复杂，先固定节点，（最小上升子序列），</p>
<p>每当更新发生时，react会从fiber的根节点开始，一个一个地循环遍历所有的fiber。</p>
<p>react 通过循环，一个一个地对fiber执行performUnitOfWork操作，以此实现了任务分片。</p>
<p>时间分片的逻辑藏在循环里。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//react-reconciler -&gt; ReactFiberWorkLoop.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">workLoopConcurrent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Perform work until Scheduler asks us to yield</span></span><br><span class="line">  <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span> &amp;&amp; !<span class="title function_">shouldYield</span>()) &#123;</span><br><span class="line">    workInProgress = <span class="title function_">performUnitOfWork</span>(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>performUnitOfWork可能返回null或者下一个需要被执行的fiber，返回结果存在workInProgress中。workInProgress在react-reconciler模块中是全局变量。</p>
<p>当shouldYield返回true的时候，循环语句中断，一个时间分片就结束了，浏览器将重获控制权。</p>
<p>以下任意条件成立时，shouldYield会返回true</p>
<ul>
<li>时间片到期（默认5ms）</li>
<li>更紧急任务插队</li>
</ul>
<p><strong>react 通过中断任务循环，实现了时间分片。</strong></p>
<p>任务恢复</p>
<p>循环中断时，下一个未被完成的任务已经被保存到react-reconciler模块的<strong>全局变量workInProgress</strong>中。下一次循环开始时就从workInProgress开始。</p>
<p>以上都发生在浏览器重获控制权之前。</p>
<p>而监听这个事件的，正是循环的发起者<strong>performWorkUntilDeadline</strong>。</p>
<p><strong>循环中断之后react执行 *port.postMessage* 发起了一个message事件，并且通过事件监听又恢复了循环</strong>。在循环中断到事件响应的间隙，浏览器重获了控制权，执行必要的渲染工作（如果有的话）。</p>
<p>以上特性，目前只在开启concurrent模式时有效。默认模式下只有任务分片，但是是同步执行的，所以不存在时间分片。</p>
<ol>
<li>使用 <code>ESLint</code> 来静态分析你的代码，开启 <code>rule-of-hooks</code> 和 <code>exhaustive-deps</code>这两个规则来捕获 <code>React</code> 错误。</li>
<li>开启 JS <code>严格模式</code>吧，都 2202 年了。</li>
<li><code>直面依赖</code>，解决在<code>useMemo</code>，<code>useCallback</code> 和 <code>useEffect</code> 上 <code>exhaustive-deps</code> 规则提示的 warning 或 error 问题。可以将最新的值挂在 ref 上来保证这些 hook 在回调中拿到的都是最新的值，同时避免不必要的重新渲染。</li>
<li>使用 map 批量渲染组件时，<code>都加上 key</code>。</li>
<li><code>只在最顶层使用 hook</code>，不要在循环、条件或嵌套语句中使用 hook。</li>
<li>理解<code>不能对已经卸载的组件执行状态更新</code>的控制台警告。</li>
<li>给不同层级的组件都添加<code>错误边界（Error Boundary）</code>来防止白屏，还可以用它来向错误监控平台（比如 <code>Sentry</code>）上报错误，并设置报警。</li>
<li>不要忽略了控制台中打印的错误和警告。</li>
<li>记得要 <code>tree-shaking</code>!</li>
<li>使用 <code>Prettier</code> 来保证代码的格式化一致性！</li>
<li>使用 <code>Typescript</code> 和 <code>NextJS</code>这样的框架来提升开发体验。</li>
<li>强烈推荐 <code>Code Climate</code>（或其他类似的）开源库。这类工具会自动检测代码异味（Code Smell，代码中的任何可能导致深层次问题的症状），它可以促使我去处理项目里留下的技术债。</li>
</ol>
<h1 id="react的渲染流程："><a href="#react的渲染流程：" class="headerlink" title="react的渲染流程："></a>react的渲染流程：</h1><p>对与首次渲染，react将react.render接受到的vnode转化为fiber树，并根据fiber树的层级结构，构建出dom树渲染到屏幕中。</p>
<p>对于更新渲染的时候，fiber树已经存在于内存之中，主要工作就是算出差异，并将变化映射到屏幕上去。</p>
<img src="/Users/yxgm/Documents/知识图鉴/assets/渲染过程.jpg" >



<h4 id="大体流程梳理："><a href="#大体流程梳理：" class="headerlink" title="大体流程梳理："></a>大体流程梳理：</h4><h5 id="不论是首屏渲染还是更新渲染，这些渲染任务都会经过scheduler的调度（排列优先级）"><a href="#不论是首屏渲染还是更新渲染，这些渲染任务都会经过scheduler的调度（排列优先级）" class="headerlink" title="不论是首屏渲染还是更新渲染，这些渲染任务都会经过scheduler的调度（排列优先级）"></a>不论是首屏渲染还是更新渲染，这些渲染任务都会经过scheduler的调度（排列优先级）</h5><blockquote>
<p>比如用户触发的更新优先级非常高，如果当前正在进行一个比较耗时的任务，则这个任务就会被用户触发的更新打断，在Scheduler中初始化任务的时候会计算一个过期时间，不同类型的任务过期时间不同，优先级越高的任务，过期时间越短，优先级越低的任务，过期时间越长。在最新的Lane模型中，则可以更加细粒度的根据二进制1的位置，来决定任务的优先级，通过二进制的融合和相交，判断任务的优先级是否足够在此次render的渲染</p>
</blockquote>
<p>scheduler调度器会给渲染任务一个事件片（默认5ms），如果没有执行完的话，就会让当前渲染到fiber节点暂停任务，让出控制权交给浏览器，在之后浏览器空闲的时候，从之前暂停的那个fiber节点，继续后面的任务，然而我现在说的这个任务就是计算fiber的差异，并且标记副作用的tag，</p>
<p>在render阶段：render阶段的主角是Reconciler，在mount阶段和update阶段，它会比较jsx和当前Fiber节点的差异（diff算法指的就是这个比较的过程），将带有副作用的Fiber节点标记出来，这些副作用有Placement（插入）、Update（更新）、Deletetion（删除）等，而这些带有副作用Fiber节点会加入一条EffectList中，在commit阶段就会遍历这条EffectList，处理相应的副作用，并且应用到真实节点上。而Scheduler和Reconciler都是在内存中工作的，所以他们不影响最后的呈现。</p>
<p>在commit阶段：会遍历EffectList，处理相应的生命周期，将这些副作用应用到真实节点，这个过程会对应不同的渲染器，在浏览器的环境中就是react-dom，在canvas或者svg中就是reac-art等。</p>
<p>fiber是实现时间分片和任务分片的基础，分片的目的只有一个，就是在reconciler阶段（纯JS计算）中一点一点的执行任务，并且带有优先级机制，让用户的交互快速响应的一个东西</p>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="m-pagination col-md-8 col-md-offset-2 col-sm-24" role="pagination">
    
    <a class="pull-left" href="/%E4%B8%9A%E5%8A%A1%E5%92%8C%E6%80%9D%E6%83%B3/%E5%BE%AE%E5%89%8D%E7%AB%AF%E6%B5%85%E8%AF%BB/" style="float: left;">
        ← 微前端浅读
    </a>
    
    
    <a class="pull-right" href="/1-TypeScript/%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/">
        基础概念 →
    </a>
    
</nav>

        <div class="col-md-8 col-md-offset-2 col-sm-24"><script type="text/javascript">
  /**
   * 搜狐畅言
   */

  /*
  document.write('<div id="SOHUCS" sid="' + window.location.pathname.slice(1) + '" ></div>');

  window.onload = function () {
    (function () {
      var appid = 'cytXXXX';
      var conf = 'prod_xxxxxxxxxxxxxxxxx';
      var width = window.innerWidth || document.documentElement.clientWidth;
      var loadJs = function (d, a, id) {
        var c = document.getElementsByTagName("head")[0] || document.head || document.documentElement;
        var b = document.createElement("script");
        b.setAttribute("type", "text/javascript");
        b.setAttribute("charset", "UTF-8");
        b.setAttribute("src", d);
        if (id) {
          b.setAttribute("id", id);
        }
        if (typeof a === "function") {
          if (window.attachEvent) {
            b.onreadystatechange = function () {
              var e = b.readyState;
              if (e === "loaded" || e === "complete") {
                b.onreadystatechange = null;
                a()
              }
            }
          } else {
            b.onload = a
          }
        }
        c.appendChild(b)
      };

      loadJs("https://changyan.sohu.com/upload/changyan.js", function () {
        window.changyan.api.config({
          appid: appid,
          conf: conf
        })
      });
    })();
  }
  */

</script>
</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By 盛祥玉. All Rights Reserved.
                </p>
                <p>Theme By <a target="_blank" rel="noopener" href="//go.kieran.top" style="color: #767D84">Kieran</a></p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/Yxgm" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    
                    
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->
      <!-- Load our scripts -->
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };

    resizeHero();

    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$('#intro').find('img').each(function(){
  var alt = this.alt;

  if (alt){
    $(this).after('<span class="caption" style="display:none">' + alt + '</span>');
  }

  $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="gallery" />');
});
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



      
</body>
</html>
